<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title id="pageTitle"></title>
  <style>
    /* ======================= 기본 색상 및 변수 ======================= */
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --secondary-color: #2c3e50;
      --light-gray: #f8f9fa;
      --light-gray-2: #ecf0f1;
      --success-color: #2ecc71;
      --success-dark: #27ae60;
      --warning-color: #f39c12;
      --warning-dark: #d35400;
      --danger-color: #e74c3c;
      --danger-dark: #c0392b;
      --purple-color: #9b59b6;
      --purple-dark: #8e44ad;
      --disabled-color: #bdc3c7;
      --button-color: #322D55;
      --complete-button-color: #8957a1;
      --progress-left-color: #00D2F7;
      --progress-right-color: #7DF9AA;
      --progress-gradient: linear-gradient(90deg, var(--progress-left-color) 0%, var(--progress-right-color) 100%);
      --progress-shine: rgba(255,255,255,0.35);
      --main-font: 'Noto Sans KR', sans-serif;
      --base-font-size: 16px;
      --small-font-size: 0.9rem;
      --medium-font-size: 1.2rem;
      --large-font-size: 1.3rem;
      --x-large-font-size: 2rem;
      --container-padding: 30px;
      --item-margin: 15px;
      --small-gap: 10px;
      --large-gap: 25px;
      --border-radius-small: 5px;
      --border-radius-medium: 8px;
      --border-radius-large: 10px;
      --border-radius-x-large: 12px;
      --box-shadow-light: 0 2px 5px rgba(0,0,0,0.1);
      --box-shadow-medium: 0 4px 10px rgba(0,0,0,0.1);
      --box-shadow-heavy: 0 8px 20px rgba(0,0,0,0.15);
      --button-padding: 14px 24px;
      --button-font-size: 16px;
      --button-margin: 10px 5px;
      --button-transform: translateY(-4px);
      --option-min-width: 100px;
      --option-padding-h: 15px;
      --option-padding-v: 10px;
      --option-font-size: 16px;
      --input-padding: 15px 20px;
      --input-font-size: 16px;
      --game-title-font-size: 32px;
      --container-max-width: 1100px;
      --container-width: 95%;
      --progress-height: 15px;
    }
    
    /* ======================= 공통 배경 및 레이아웃 ======================= */
    body {
      margin: 0;
      padding: 10px;
      font-family: var(--main-font);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z");
      opacity: 0.3;
      z-index: -1;
    }
    
    /* ======================= 배너 & 제목 ======================= */
    .banner {
      width: 100%;
      text-align: center;
      background-color: white;
      padding: 15px 0;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
    }
    .banner img {
      max-width: 100%;
      height: auto;
    }
    #gameTitle {
      text-align: center;
      font-size: var(--game-title-font-size);
      font-weight: bold;
      margin-bottom: 20px;
      color: var(--secondary-color);
      text-shadow: 2px 2px 2px rgba(0,0,0,0.2), 0 0 15px rgba(255,255,255,0.8);
      position: relative;
      padding: 15px 30px;
      border-radius: var(--border-radius-x-large);
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(240,242,245,0.85) 100%);
      backdrop-filter: blur(4px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08), inset 0 -2px 5px rgba(255,255,255,0.7);
      display: inline-block;
      letter-spacing: 1px;
      transform: perspective(100px) translateZ(5px);
      border: 1px solid rgba(255,255,255,0.7);
    }
    #gameTitle::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--button-color), var(--purple-color));
      border-radius: 3px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* ======================= 컨테이너 & 정보 패널 ======================= */
    .container {
      max-width: var(--container-max-width);
      width: var(--container-width);
      margin: 0 auto;
      background-color: rgba(255,255,255,0.9);
      border-radius: var(--border-radius-x-large);
      box-shadow: var(--box-shadow-medium);
      padding: var(--container-padding);
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    .container:hover { 
      box-shadow: var(--box-shadow-heavy); 
    }
    
    /* 정보 패널 */
    .info-panel {
      display: flex;
      justify-content: center;
      background-color: var(--light-gray);
      padding: 15px;
      border-radius: var(--border-radius-large);
      margin-bottom: 25px;
      box-shadow: var(--box-shadow-light);
    }
    .info-item {
      text-align: center;
      padding: 0 15px;
      flex: 1;
    }
    .info-label {
      font-weight: 500;
      margin-bottom: 5px;
      color: #7f8c8d;
      font-size: var(--small-font-size);
      text-transform: uppercase;
    }
    .info-value {
      font-size: var(--large-font-size);
      color: var(--secondary-color);
      font-weight: bold;
    }
    
    /* 기회 표시 스타일 */
    .chances-container {
      display: flex;
      gap: 5px;
      justify-content: center;
      margin-top: 5px;
    }
    .chance-indicator {
      width: 40px;
      height: 16px;
      background-color: var(--success-color);
      border-radius: 4px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .chance-indicator.lost {
      background-color: #ecf0f1;
    }
    
    /* ======================= 시작 화면 ======================= */
    #startSection {
      text-align: center;
      padding: 40px 0;
      background-color: rgba(255,255,255,0.8);
      border-radius: var(--border-radius-x-large);
      box-shadow: var(--box-shadow-medium);
      max-width: 600px;
      margin: 40px auto;
      position: relative;
      z-index: 1;
    }
    .start-title {
      font-size: 28px;
      margin-bottom: 30px;
      color: var(--secondary-color);
    }
    .input-field {
      padding: var(--input-padding);
      font-size: var(--input-font-size);
      border: none;
      border-radius: 10px;
      width: 300px;
      margin-right: 10px;
      outline: none;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1), inset 0 2px 5px rgba(0,0,0,0.05);
      background-color: white;
      color: var(--secondary-color);
    }
    
    /* ======================= 버튼 스타일 (통일: Bar 형태) ======================= */
    .btn, .option {
      border: none;
      border-radius: var(--border-radius-medium);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      padding: var(--button-padding);
      font-size: var(--button-font-size);
      margin: var(--button-margin);
      position: relative;
      overflow: hidden;
      background: var(--primary-color);
      color: white;
      text-align: center;
      transform: perspective(500px) translateZ(5px);
    }
    .btn:hover, .option:hover {
      transform: perspective(500px) translateZ(8px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    .btn:active, .option:active {
      transform: perspective(500px) translateZ(2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .option {
      display: inline-block;
      min-width: var(--option-min-width);
      padding: var(--option-padding-v) var(--option-padding-h);
      font-size: var(--option-font-size);
    }
    .option.selected {
      border: 2px solid var(--warning-color);
    }
    .option.correct {
      border: 2px solid var(--success-color);
    }
    .option.incorrect {
      border: 2px solid var(--danger-color);
    }
    
    /* ======================= 문제 영역 ======================= */
    #gameSection {
      display: none;
      width: 100%;
    }
    .question-container {
      display: flex;
      flex-direction: row;
      margin-bottom: 30px;
      background-color: var(--light-gray);
      border-radius: var(--border-radius-large);
      box-shadow: var(--box-shadow-medium);
      padding: 20px;
      min-height: 500px;
      overflow: hidden;
      position: relative;
    }
    .passage {
      flex: 0 0 38%;
      padding-right: 10px;
      max-height: 600px;
      overflow-y: auto;
      border-right: 1px solid #eee;
      display: none;
    }
    .question {
      flex: 1;
      padding: 15px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .question-number {
      font-size: var(--medium-font-size);
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--secondary-color);
      background-color: var(--light-gray-2);
      padding: 8px 15px;
      border-radius: 20px;
      box-shadow: var(--box-shadow-light);
    }
    .question-images {
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
      max-width: 800px;
    }
    .image-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .question-image {
      width: 100%;
      height: auto;
      border-radius: var(--border-radius-small);
      box-shadow: var(--box-shadow-light);
      margin-bottom: 10px;
    }
    
    /* 옵션 영역 (객관식) */
    .options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 30px 0;
      width: 100%;
    }
    .options.vertical {
      flex-direction: column;
      align-items: center;
    }
    
    /* 주관식 입력 영역 */
    .input-answer {
      display: none;
      flex-direction: column;
      align-items: center;
      margin: 30px 0;
      width: 100%;
    }
    .input-answer-fields {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 15px;
      align-items: center;
    }
    .answer-input {
      padding: var(--input-padding);
      font-size: var(--input-font-size);
      border: none;
      border-radius: 10px;
      width: 100%;
      outline: none;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1), inset 0 2px 5px rgba(0,0,0,0.05);
      background-color: white;
      color: var(--secondary-color);
      box-sizing: border-box;
    }
    
    /* 진행률 게이지 */
    .progress-container {
      width: 100%;
      height: var(--progress-height);
      background-color: rgba(236,240,241,0.8);
      border-radius: 8px;
      margin: 30px 0 15px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-image: var(--progress-gradient);
      transition: width 0.7s cubic-bezier(0.22,0.61,0.36,1.2);
      border-radius: 8px;
      box-shadow: var(--box-shadow-light);
    }
    .progress-indicator {
      position: absolute;
      right: 10px;
      top: -25px;
      background-color: var(--secondary-color);
      color: white;
      font-size: 0.8rem;
      padding: 3px 10px;
      border-radius: 12px;
      box-shadow: var(--box-shadow-light);
    }
    
    /* ======================= 결과 화면 ======================= */
    #resultSection {
      display: none;
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: var(--border-radius-x-large);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 700px;
      margin: 40px auto;
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .result-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 25px;
      color: var(--secondary-color);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    .result-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--button-color), var(--purple-color));
      border-radius: 3px;
    }
    .result-info {
      font-size: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: rgba(255,255,255,0.7);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }
    #submitButton {
      background-color: var(--warning-color);
    }
    
    /* 로딩 스피너 */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--button-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 반응형 디자인 */
    @media (max-width: 480px) {
      .container { padding: 10px; width: 100%; border-radius: 8px; }
      #gameTitle { font-size: 24px; }
      .info-panel { padding: 8px 3px; margin-bottom: 15px; }
      .info-label { font-size: 0.7rem; margin-bottom: 3px; }
      .info-value { font-size: 1rem; }
      .btn, .option { padding: 10px 15px; font-size: 0.9rem; margin: 8px 3px; }
      .input-field, .answer-input { width: 100%; }
      #startSection { padding: 20px 10px; }
    }
  </style>
</head>
<body>
  <!-- 배너 영역 -->
  <div class="banner" id="banner"></div>
  <!-- 게임 제목 -->
  <h1 id="gameTitle"></h1>
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>
  <div class="container">
    <!-- 시작 화면 -->
    <div id="startSection">
      <h2 class="start-title">이름을 입력하고 게임을 시작하세요</h2>
      <div>
        <input class="input-field" id="playerName" placeholder="이름을 입력하세요" type="text"/>
        <button class="btn" id="startButton">게임시작</button>
      </div>
    </div>
    <!-- 게임 진행 화면 -->
    <div id="gameSection">
      <div class="info-panel">
        <div class="info-item">
          <div class="info-label">경과시간</div>
          <div class="info-value" id="timer">00:00</div>
        </div>
        <div class="info-item">
          <div class="info-label">현재 점수</div>
          <div class="info-value" id="currentScore">0</div>
        </div>
        <div class="info-item">
          <div class="info-label">남은 기회</div>
          <div class="chances-container">
            <div class="chance-indicator" id="chance1"></div>
            <div class="chance-indicator" id="chance2"></div>
            <div class="chance-indicator" id="chance3"></div>
          </div>
        </div>
      </div>
      <div class="question-container" id="questionContainer">
        <div class="passage" id="passage"></div>
        <div class="question" id="question">
          <div class="question-number" id="questionNumber">문제 1</div>
          <div class="question-images" id="questionImages"></div>
          <div class="options" id="multipleChoice"></div>
          <div class="input-answer" id="shortAnswer"></div>
          <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-indicator" id="progressIndicator">0/0</div>
          </div>
          <button class="btn" id="nextButton" disabled>다음문제</button>
        </div>
      </div>
    </div>
    <!-- 결과 화면 -->
    <div id="resultSection">
      <div class="result-title">게임 종료</div>
      <div class="result-info" id="finalScore"></div>
      <div class="result-info" id="finalTime"></div>
      <button class="btn" id="submitButton">전송하기</button>
      <div id="serverResponse" style="margin-top:20px;"></div>
    </div>
  </div>
  
  <script>
    /* 게임 설정 및 문제 데이터 */
    const gameConfig = {
      "gameTitle": "GTP버전 2차 테스트",
      "defaultScore": 10,
      "bannerURL": "",
      "randomizeQuestions": false,
      "questions": [
      {
        "id": 1,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/1.png?raw=true"
        ],
        "passage": "",
        "answer": "1",
        "type": "객관식",
        "score": 10
      },
      {
        "id": 2,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/2.png?raw=true"
        ],
        "passage": "",
        "answer": ["2", "3"],
        "type": "객관식",
        "score": 10
      },
      {
        "id": 3,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/3.png?raw=true"
        ],
        "passage": "",
        "answer": "4",
        "type": "객관식",
        "score": 10
      },
      {
        "id": 4,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/4.png?raw=true"
        ],
        "passage": "",
        "answer": "1",
        "type": "객관식",
        "score": 10,
        "customOptions": ["ABCDEFGHI", "가나다라마바사", "ⓐⓑⓒⓓⓔⓕⓖⓗⓘ", "!@#$%^&&((()_+{}"]
      },
      {
        "id": 5,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/5.png?raw=true"
        ],
        "passage": "",
        "answer": "15",
        "type": "주관식",
        "score": 10
      },
      {
        "id": 6,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/6.png?raw=true"
        ],
        "passage": "",
        "answer": ["apple", "banana"],
        "type": "주관식",
        "score": 10,
        "placeholders": ["첫 번째 과일", "두 번째 과일"]
      },
      {
        "id": 7,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/1.png?raw=true"
        ],
        "passage": "https://search.pstatic.net/sunny/?src=https%3A%2F%2Fcdn.crowdpic.net%2Fdetail-thumb%2Fthumb_d_EF9A7AA52456105C3DA44F0FC59B7515.jpg&type=sc960_832",
        "answer": "3",  // 3번째 옵션이 정답
        "type": "객관식",
        "score": 10,
        "customOptions": ["A", "B", "C", "D"]
      },
      {
        "id": 8,
        "images": [
          "https://github.com/hwimath2/imagrfile/blob/main/%EB%8B%A4%ED%95%AD%EC%8B%9D%20%EA%B3%B1/2.png?raw=true"
        ],
        "passage": "",
        "answer": "2",  // 2번째 옵션이 정답
        "type": "객관식",
        "score": 10,
        "customOptions": ["오늘 밤", "오늘 아침", "오늘 새벽"]
      }
      ]
    };
    const gameTitle = gameConfig.gameTitle;
    const questions = gameConfig.questions;
    const defaultScore = gameConfig.defaultScore || 10;
    const bannerURL = gameConfig.bannerURL || "";
    const randomizeQuestions = gameConfig.randomizeQuestions || false;
    
    /* 텍스트 설정 */
    const START_SCREEN_TITLE = "이름을 입력하고 게임을 시작하세요";
    const PLAYER_NAME_PLACEHOLDER = "이름을 입력하세요";
    const START_BUTTON_TEXT = "게임시작";
    const NEXT_BUTTON_TEXT = "다음문제";
    const COMPLETE_BUTTON_TEXT = "완료";
    const CHECK_BUTTON_TEXT = "확인";
    const SUBMIT_BUTTON_TEXT = "전송하기";
    const RESULT_TITLE_TEXT = "게임 종료";
    const UNATTEMPTED_TEXT = "미응시";
    
    const SUCCESS_MESSAGE = "성공: 데이터가 성공적으로 전송되었습니다.";
    const ERROR_MESSAGE = "오류: 데이터 전송에 실패했습니다.";
    const NETWORK_ERROR = "네트워크 오류: 서버와 통신할 수 없습니다.";
    
    /* 전역 변수 선언 */
    let currentQuestion = 0, score = 0, elapsedTime = 0, timerInterval = null, startTime = 0;
    let gameOver = false, userAnswers = [], answerSubmitted = false, completedQuestions = 0;
    let remainingChances = 3, selectedOptions = [], player = "";
    
    /* DOM 요소 참조 (최상단에 선언하여 이후 코드에서 안전하게 사용) */
    const elements = {
      banner: document.getElementById("banner"),
      gameTitle: document.getElementById("gameTitle"),
      startSection: document.getElementById('startSection'),
      gameSection: document.getElementById('gameSection'),
      resultSection: document.getElementById('resultSection'),
      playerName: document.getElementById('playerName'),
      startButton: document.getElementById('startButton'),
      timer: document.getElementById('timer'),
      currentScore: document.getElementById('currentScore'),
      questionContainer: document.getElementById('questionContainer'),
      passage: document.getElementById('passage'),
      question: document.getElementById('question'),
      questionNumber: document.getElementById('questionNumber'),
      questionImages: document.getElementById('questionImages'),
      multipleChoice: document.getElementById('multipleChoice'),
      shortAnswer: document.getElementById('shortAnswer'),
      nextButton: document.getElementById('nextButton'),
      submitButton: document.getElementById('submitButton'),
      finalScore: document.getElementById('finalScore'),
      finalTime: document.getElementById('finalTime'),
      serverResponse: document.getElementById('serverResponse'),
      progressBar: document.getElementById('progressBar'),
      progressIndicator: document.getElementById('progressIndicator'),
      loadingSpinner: document.getElementById('loadingSpinner'),
      chance1: document.getElementById('chance1'),
      chance2: document.getElementById('chance2'),
      chance3: document.getElementById('chance3')
    };
    
    /* 타이머 함수 */
    const timerFunctions = {
      start() {
        startTime = Date.now();
        timerInterval = setInterval(this.update, 1000);
      },
      update() {
        elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
        const s = (elapsedTime % 60).toString().padStart(2, '0');
        elements.timer.textContent = `${m}:${s}`;
      },
      stop() { clearInterval(timerInterval); },
      formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}분 ${s}초`;
      }
    };
    
    /* 게임 초기화 함수 */
    function resetGame() {
      if(randomizeQuestions) { questions.sort(() => Math.random() - 0.5); }
      currentQuestion = 0; score = 0; elapsedTime = 0; gameOver = false;
      userAnswers = []; answerSubmitted = false; completedQuestions = 0;
      remainingChances = 3; selectedOptions = [];
      elements.timer.textContent = "00:00";
      elements.currentScore.textContent = "0";
      updateChancesDisplay();
      updateProgressBar();
    }
    
    // 진행률 게이지 업데이트 함수
    function updateProgressBar() {
      const progress = (completedQuestions / questions.length) * 100;
      elements.progressBar.style.width = `${progress}%`;
      elements.progressIndicator.textContent = `${completedQuestions}/${questions.length}`;
    }
    
    // 남은 기회 업데이트
    function updateChancesDisplay() {
      elements.chance1.className = remainingChances >= 1 ? 'chance-indicator' : 'chance-indicator lost';
      elements.chance2.className = remainingChances >= 2 ? 'chance-indicator' : 'chance-indicator lost';
      elements.chance3.className = remainingChances >= 3 ? 'chance-indicator' : 'chance-indicator lost';
    }
    
    // 문제 로드 함수
    function loadQuestion(qIndex) {
      answerSubmitted = false;
      selectedOptions = [];
      const existingConfirm = document.getElementById('checkButton');
      if(existingConfirm && existingConfirm.parentNode) { existingConfirm.parentNode.removeChild(existingConfirm); }
      elements.multipleChoice.innerHTML = "";
      elements.shortAnswer.innerHTML = "";
      const q = questions[qIndex];
      if(!q) { endGame(true); return; }
      elements.questionNumber.textContent = `문제 ${qIndex + 1}`;
      if(q.passage) {
        elements.passage.style.display = 'block';
        elements.passage.innerHTML = `<img src="${q.passage}" alt="보기" style="width:100%;">`;
      } else { elements.passage.style.display = 'none'; }
      elements.questionImages.innerHTML = "";
      const imgContainer = document.createElement('div');
      imgContainer.className = "image-container";
      q.images.forEach((imgUrl, idx) => {
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = `문제 ${qIndex + 1} 이미지 ${idx + 1}`;
        img.className = "question-image";
        imgContainer.appendChild(img);
      });
      elements.questionImages.appendChild(imgContainer);
      if(q.type === "객관식") {
        elements.multipleChoice.style.display = "flex";
        elements.shortAnswer.style.display = "none";
        let options = [];
        if(q.customOptions && Array.isArray(q.customOptions) && q.customOptions.length > 0) {
          options = q.customOptions.slice(0,5);
        } else { options = ["1", "2", "3", "4", "5"]; }
        let maxLen = 0; options.forEach(opt => { if(opt.length > maxLen) maxLen = opt.length; });
        const computedWidth = Math.min((maxLen * 10) + 30, elements.questionContainer.clientWidth * 0.33);
        options.forEach((optText, index) => {
          const optDiv = document.createElement('div');
          optDiv.className = "option";
          optDiv.style.width = computedWidth + "px";
          optDiv.setAttribute("data-option", (index+1).toString());
          optDiv.textContent = optText;
          optDiv.addEventListener('click', handleOptionClick);
          elements.multipleChoice.appendChild(optDiv);
        });
        if(computedWidth >= elements.questionContainer.clientWidth * 0.33) {
          elements.multipleChoice.classList.add('vertical');
        } else { elements.multipleChoice.classList.remove('vertical'); }
        if(Array.isArray(q.answer) && q.answer.length > 1) { createConfirmButton(handleMultipleChoiceCheck); }
      } else if(q.type === "주관식") {
        elements.multipleChoice.style.display = "none";
        elements.shortAnswer.style.display = "flex";
        let inputHTML = '<div class="input-answer-fields">';
        if(Array.isArray(q.answer)) {
          let maxLen = 0;
          q.answer.slice(0,5).forEach(ans => { if(ans.toString().length > maxLen) maxLen = ans.toString().length; });
          const baseWidth = 300, computedWidth = (maxLen * 10) + 20;
          const finalWidth = Math.max(baseWidth, computedWidth);
          for(let i = 0; i < Math.min(q.answer.length,5); i++) {
            const placeholder = (q.placeholders && q.placeholders[i]) ? q.placeholders[i] : `답변 ${i+1}`;
            inputHTML += `<div style="width: ${finalWidth}px; margin: 5px 0;">
                            <input class="answer-input" id="answerInput${i+1}" placeholder="${placeholder}" type="text"/>
                          </div>`;
          }
        } else {
          inputHTML += `<div style="width: 300px; margin: 5px 0;">
                          <input class="answer-input" id="answerInput" placeholder="답을 입력하세요" type="text"/>
                        </div>`;
        }
        inputHTML += '</div>';
        elements.shortAnswer.innerHTML = inputHTML;
        document.querySelectorAll('.answer-input').forEach(input => {
          input.addEventListener('input', handleShortAnswerInput);
          input.addEventListener('keyup', (e) => {
            if(e.key === 'Enter' && !document.getElementById('checkButton').disabled) {
              document.getElementById('checkButton').click();
            }
          });
        });
        createConfirmButton(handleCheckButtonClick);
      }
      if(qIndex === questions.length - 1) {
        elements.nextButton.textContent = COMPLETE_BUTTON_TEXT;
        elements.nextButton.classList.add('complete-button');
      } else {
        elements.nextButton.textContent = NEXT_BUTTON_TEXT;
        elements.nextButton.classList.remove('complete-button');
      }
    }
    
    function createConfirmButton(callback) {
      const existing = document.getElementById('checkButton');
      if(existing && existing.parentNode) { existing.parentNode.removeChild(existing); }
      const btn = document.createElement('button');
      btn.className = "btn"; btn.id = "checkButton"; btn.textContent = CHECK_BUTTON_TEXT; btn.disabled = true;
      btn.addEventListener('click', callback);
      if(elements.multipleChoice.style.display !== "none") {
        elements.multipleChoice.parentNode.insertBefore(btn, elements.multipleChoice.nextSibling);
      } else {
        elements.shortAnswer.parentNode.insertBefore(btn, elements.shortAnswer.nextSibling);
      }
    }
    
    function handleOptionClick(e) {
      if(gameOver || answerSubmitted) return;
      const selectedOption = e.currentTarget;
      const q = questions[currentQuestion];
      const userAnswer = selectedOption.getAttribute('data-option');
      if(!(Array.isArray(q.answer) && q.answer.length > 1)) {
        answerSubmitted = true;
        if(userAnswer === q.answer.toString()) {
          selectedOption.classList.add("correct");
          score += q.score || defaultScore;
          elements.currentScore.textContent = score;
        } else {
          selectedOption.classList.add("incorrect");
          remainingChances--;
          updateChancesDisplay();
          if(remainingChances <= 0) { setTimeout(() => { endGame(false); }, 1000); return; }
        }
        userAnswers.push({
          questionId: q.id,
          userAnswer: userAnswer,
          correctAnswer: q.answer,
          isCorrect: (userAnswer === q.answer.toString()),
          score: (userAnswer === q.answer.toString()) ? (q.score || defaultScore) : 0
        });
        elements.nextButton.disabled = false;
      } else {
        if(selectedOptions.includes(userAnswer)) {
          selectedOptions = selectedOptions.filter(opt => opt !== userAnswer);
          selectedOption.classList.remove("selected");
        } else {
          selectedOptions.push(userAnswer);
          selectedOption.classList.add("selected");
        }
        const confirmBtn = document.getElementById('checkButton');
        if(confirmBtn) { confirmBtn.disabled = (selectedOptions.length === 0); }
      }
    }
    
    function handleMultipleChoiceCheck() {
      if(gameOver || answerSubmitted) return;
      const q = questions[currentQuestion];
      answerSubmitted = true;
      let allCorrect = true;
      if(selectedOptions.length !== q.answer.length) { allCorrect = false; }
      else { selectedOptions.forEach(opt => { if(!q.answer.includes(opt)) { allCorrect = false; } }); }
      document.querySelectorAll('.option').forEach(opt => {
        const optVal = opt.getAttribute('data-option');
        if(selectedOptions.includes(optVal)) {
          if(q.answer.includes(optVal)) { opt.classList.add("correct"); }
          else { opt.classList.add("incorrect"); }
        }
      });
      if(allCorrect) { score += q.score || defaultScore; elements.currentScore.textContent = score; }
      else { remainingChances--; updateChancesDisplay(); if(remainingChances <= 0) { setTimeout(() => { endGame(false); }, 1000); return; } }
      document.getElementById('checkButton').disabled = true;
      elements.nextButton.disabled = false;
      userAnswers.push({
        questionId: q.id,
        userAnswer: selectedOptions,
        correctAnswer: q.answer,
        isCorrect: allCorrect,
        score: allCorrect ? (q.score || defaultScore) : 0
      });
    }
    
    function handleShortAnswerInput() {
      if(gameOver || answerSubmitted) return;
      const inputs = document.querySelectorAll('.answer-input');
      let allFilled = true;
      inputs.forEach(input => { if(input.value.trim() === "") { allFilled = false; } });
      const confirmBtn = document.getElementById('checkButton');
      if(confirmBtn) { confirmBtn.disabled = !allFilled; }
    }
    
    function handleCheckButtonClick() {
      if(gameOver || answerSubmitted) return;
      const q = questions[currentQuestion];
      const inputs = document.querySelectorAll('.answer-input');
      answerSubmitted = true;
      let isCorrect = true;
      let userAnswerArray = [];
      inputs.forEach((input, index) => {
        const userAns = input.value.trim().toLowerCase();
        userAnswerArray.push(userAns);
        let correctAns = "";
        if(Array.isArray(q.answer)) { correctAns = q.answer[index].toString().toLowerCase(); }
        else { correctAns = q.answer.toString().toLowerCase(); }
        if(userAns !== correctAns) { isCorrect = false; input.style.border = "2px solid var(--danger-color)"; }
        else { input.style.border = "2px solid var(--success-color)"; }
      });
      if(isCorrect) { score += q.score || defaultScore; elements.currentScore.textContent = score; }
      else { remainingChances--; updateChancesDisplay(); if(remainingChances <= 0) { setTimeout(() => { endGame(false); }, 1000); return; } }
      document.getElementById('checkButton').disabled = true;
      elements.nextButton.disabled = false;
      userAnswers.push({
        questionId: q.id,
        userAnswer: userAnswerArray,
        correctAnswer: q.answer,
        isCorrect: isCorrect,
        score: isCorrect ? (q.score || defaultScore) : 0
      });
    }
    
    elements.nextButton.addEventListener('click', () => {
      currentQuestion++;
      completedQuestions++;
      updateProgressBar();
      if(currentQuestion >= questions.length) { endGame(true); }
      else { loadQuestion(currentQuestion); }
    });
    
    elements.startButton.addEventListener('click', () => {
      const name = elements.playerName.value.trim();
      if(name === "") return;
      player = name;
      elements.startSection.style.display = "none";
      elements.gameSection.style.display = "block";
      timerFunctions.start();
      resetGame();
      loadQuestion(currentQuestion);
    });
    
    // 수정된 전송 함수: 타임아웃과 재시도 로직 추가
    async function sendDataWithRetry(url, data, { timeout = 5000, retries = 3 } = {}) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeout);
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
            signal: controller.signal
          });
          clearTimeout(timer);
          const responseData = await response.json();
          if (response.ok) {
            return responseData;
          } else {
            throw new Error("Server error: " + JSON.stringify(responseData, null, 2));
          }
        } catch (error) {
          clearTimeout(timer);
          if (attempt === retries) {
            throw error;
          }
          // 지수 백오프: 시도 횟수에 따라 대기 시간 증가
          await new Promise(res => setTimeout(res, 1000 * attempt));
        }
      }
    }
    
    elements.submitButton.addEventListener('click', async () => {
      const game = gameConfig.gameTitle;
      const name = elements.playerName.value.trim();
      const finalScore = score, finalElapsedTime = elapsedTime;
      elements.loadingSpinner.style.display = "flex";
      try {
        const data = await sendDataWithRetry("https://us-central1-record-f420d.cloudfunctions.net/report", {
          game: game,
          name: name,
          score: parseInt(finalScore, 10),
          elapsedTime: parseInt(finalElapsedTime, 10)
        }, { timeout: 5000, retries: 3 });
        elements.serverResponse.textContent = `성공: ${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        elements.serverResponse.textContent = `오류: ${error.message}`;
      } finally {
        elements.loadingSpinner.style.display = "none";
      }
    });
    
    function endGame(completed) {
      gameOver = true;
      timerFunctions.stop();
      elements.gameSection.style.display = "none";
      elements.resultSection.style.display = "block";
      elements.finalScore.textContent = `최종 점수: ${score}`;
      elements.finalTime.textContent = `총 소요 시간: ${timerFunctions.formatTime(elapsedTime)}`;
    }
    
    window.onload = () => {
      document.getElementById("pageTitle").textContent = gameTitle;
      elements.gameTitle.textContent = gameTitle;
    };
  </script>
</body>
</html>
